- name: Loome andmebaasi Wordpressile koos kasutajaga
  hosts: webservers
  become: yes
  tasks:
    - name: Kontrollime, kas andmebaas juba eksisteerib
      shell: |
        mysql -NBe "SELECT SCHEMA_NAME
                    FROM INFORMATION_SCHEMA.SCHEMATA
                    WHERE SCHEMA_NAME='wpdatabase';"
      register: db_exists
      changed_when: false
      failed_when: false

    - name: Loome andmebaasi wpdatabase (utf8mb4)
      shell: >
        mysql -e
        "CREATE DATABASE \`wpdatabase\`
         CHARACTER SET utf8mb4
         COLLATE utf8mb4_unicode_ci;"
      when: db_exists.stdout == ""

    - name: Kontrollime, kas kasutaja wpuser@localhost eksisteerib
      shell: |
        mysql -NBe "SELECT 1 FROM mysql.user
                    WHERE user='wpuser' AND host='localhost' LIMIT 1;"
      register: user_exists
      changed_when: false
      failed_when: false

    - name: Loome kasutaja wpuser pluginaga caching_sha2_password
      shell: >
        mysql -e
        "CREATE USER 'wpuser'@'localhost'
         IDENTIFIED WITH caching_sha2_password BY 'qwerty';"
      when: user_exists.stdout == ""

    - name: Veendume, et wpuser kasutab caching_sha2_password soovitud parooliga
      shell: >
        mysql -e
        "ALTER USER 'wpuser'@'localhost'
         IDENTIFIED WITH caching_sha2_password BY 'qwerty';"

    - name: Anname wpuser-ile kõik õigused wpdatabase-is
      shell: >
        mysql -e
        "GRANT ALL PRIVILEGES ON \`wpdatabase\`.* TO 'wpuser'@'localhost' WITH GRANT OPTION;
         FLUSH PRIVILEGES;"
      changed_when: false

    - name: Laadime alla WordPressi
      get_url:
        url: https://wordpress.org/latest.tar.gz
        dest: /tmp/wordpress.tar.gz

    - name: Pakime WordPressi lahti
      unarchive:
        src: /tmp/wordpress.tar.gz
        dest: /var/www/html/
        remote_src: yes

    - name: Kopeerime wp-config-sample.php kui wp-config.php vajalikku kohta
      copy:
        src: /var/www/html/wordpress/wp-config-sample.php
        dest: /var/www/html/wordpress/wp-config.php
        remote_src: yes

    - name: Määrame andmebaasi nime
      lineinfile:
        path: /var/www/html/wordpress/wp-config.php
        regexp: "database_name_here"
        line: "define('DB_NAME', 'wpdatabase');"

    - name: Määrame andmebaasi kasutajanime
      lineinfile:
        path: /var/www/html/wordpress/wp-config.php
        regexp: "username_here"
        line: "define('DB_USER', 'wpuser');"

    - name: Määrame andmebaasi kasutaja parooli
      lineinfile:
        path: /var/www/html/wordpress/wp-config.php
        regexp: "password_here"
        line: "define('DB_PASSWORD', 'qwerty');"

    - name: Ensure ownership to www-data
      ansible.builtin.file:
        path: /var/www/html/wordpress
        owner: www-data
        group: www-data
        recurse: yes

    - name: Paneme kausta õigusteks 755
      ansible.builtin.shell: "find /var/www/html/wordpress -type d -exec chmod 755 {} +"

    - name: Paneme failide õigusteks 644
      ansible.builtin.shell: "find /var/www/html/wordpress -type f -exec chmod 644 {} +"

    - name: Taaskäivitame Apache
      service:
        name: apache2
        state: restarted
